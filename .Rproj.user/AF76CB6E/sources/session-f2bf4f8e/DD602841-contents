#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    https://shiny.posit.co/
#

library(shiny)
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(DT)
library(shinydashboard)

dig <- read.csv("DIG.csv")%>%
  mutate(
    SEX = factor(SEX, levels = c(1, 2), labels = c("Male", "Female")),
    RACE = factor(RACE, levels = c(1, 2), labels = c("White", "Nonwhite")),
    TRTMT = factor(TRTMT, levels = c(0, 1), labels = c("Placebo", "Digoxin"))
  )


cont_vars <- c(
  "Age" = "AGE",
  "BMI" = "BMI",
  "Ejection fraction (%)" = "EJF_PER",
  "Heart rate (bpm)" = "HEARTRTE",
  "Systolic BP (mmHg)" = "SYSBP",
  "Diastolic BP (mmHg)" = "DIABP"
)

cat_vars <- c(
  "Sex" = "SEX",
  "Race" = "RACE",
  "NYHA class" = "FUNCTCLS",
  "Diabetes" = "DIABETES",
  "Hypertension" = "HYPERTEN"
)

outcome_vars <- c(
  "Death (any cause)" = "DEATH",
  "Any hospitalization" = "HOSP",
  "CVD hospitalization" = "CVD",
  "HF hospitalization" = "WHF"
)

  

# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("Old Faithful Geyser Data"),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput("bins",
                        "Number of bins:",
                        min = 1,
                        max = 50,
                        value = 30)
        ),

        # Show a plot of the generated distribution
        mainPanel(
           plotOutput("distPlot")
        )
    )
)

# Define server logic required to draw a histogram
server <- function(input, output, session) {
  
  filtered <- reactive({
    req(input$age_range, input$sex_filter, input$trt_filter)
    dig %>%
      filter(
        AGE >= input$age_range[1],
        AGE <= input$age_range[2],
        SEX %in% input$sex_filter,
        TRTMT %in% input$trt_filter
      )
  })
  
  output$n_patients <- renderValueBox({
    valueBox(
      value = nrow(dig),
      subtitle = "Patients",
      icon = icon("users"),
      color = "purple"
    )
  })
  
  output$pct_treat <- renderValueBox({
    pct <- mean(dig$TRTMT == "Digoxin") * 100
    valueBox(
      value = sprintf("%.1f%%", pct),
      subtitle = "On digoxin",
      icon = icon("capsules"),
      color = "green"
    )
  })
  
  output$mean_age <- renderValueBox({
    valueBox(
      value = sprintf("%.1f", mean(dig$AGE, na.rm = TRUE)),
      subtitle = "Mean age (years)",
      icon = icon("user-clock"),
      color = "yellow"
    )
  })
  output$age_hist <- renderPlot({
    ggplot(dig, aes(x = AGE)) +
      geom_histogram(bins = 30) +
      labs(x = "Age (years)", y = "Count")
  })
  
  output$ef_hist <- renderPlot({
    ggplot(dig, aes(x = EJF_PER)) +
      geom_histogram(bins = 30) +
      labs(x = "Ejection fraction (%)", y = "Count")
  })
  
  # Reactive subset for baseline filters
  baseline_data <- reactive({
    d <- dig
    if (input$baseline_trt != "Both") {
      d <- d %>% filter(TRTMT == input$baseline_trt)
    }
    if (input$baseline_sex != "Both") {
      d <- d %>% filter(SEX == input$baseline_sex)
    }
    d
  })
  
  # Continuous baseline plot
  output$baseline_cont_plot <- renderPlot({
    var <- input$baseline_cont
    ggplot(baseline_data(), aes(x = TRTMT, y = .data[[var]])) +
      geom_boxplot() +
      labs(x = "Treatment group", y = names(cont_vars)[cont_vars == var])
  })
  
  # Continuous baseline table
  output$baseline_cont_table <- renderDataTable({
    var <- input$baseline_cont
    baseline_data() %>%
      group_by(TRTMT) %>%
      summarise(
        n = n(),
        mean = mean(.data[[var]], na.rm = TRUE),
        sd = sd(.data[[var]], na.rm = TRUE)
      )
  })
  
  # Categorical baseline plot
  output$baseline_cat_plot <- renderPlot({
    var <- input$baseline_cat
    ggplot(baseline_data(), aes(x = .data[[var]], fill = TRTMT)) +
      geom_bar(position = "fill") +
      scale_y_continuous(labels = scales::percent_format()) +
      labs(x = names(cat_vars)[cat_vars == var], y = "Proportion")
  })
  
  # Categorical baseline table
  output$baseline_cat_table <- renderDataTable({
    var <- input$baseline_cat
    baseline_data() %>%
      count(TRTMT, !!sym(var)) %>%
      group_by(TRTMT) %>%
      mutate(pct = n / sum(n))
  })
  
  # ---- Outcomes ----
  outcome_data <- reactive({
    dig %>%
      filter(!is.na(.data[[input$outcome_var]]))
  })
  
  output$outcome_plot <- renderPlot({
    ggplot(outcome_data(),
           aes(x = .data[[input$outcome_group]],
               fill = .data[[input$outcome_var]])) +
      geom_bar(position = "fill") +
      scale_y_continuous(labels = scales::percent_format()) +
      labs(x = input$outcome_group,
           y = "Proportion",
           fill = names(outcome_vars)[outcome_vars == input$outcome_var])
  })
  
  output$outcome_table <- renderDataTable({
    outcome_data() %>%
      count(.data[[input$outcome_group]], .data[[input$outcome_var]]) %>%
      group_by(.data[[input$outcome_group]]) %>%
      mutate(pct = n / sum(n))
  })
  
  # ---- Relationships ----
  output$rel_plot <- renderPlot({
    xvar <- input$xvar
    yvar <- input$yvar
    colour_var <- input$rel_colour
    
    p <- ggplot(dig, aes(x = .data[[xvar]], y = .data[[yvar]]))
    
    if (colour_var != "None") {
      p <- p + aes(colour = .data[[colour_var]])
    }
    
    p <- p + geom_point(alpha = 0.5)
    
    if (input$add_smooth) {
      p <- p + geom_smooth(method = "loess", se = FALSE)
    }
    
    p + labs(
      x = names(cont_vars)[cont_vars == xvar],
      y = names(cont_vars)[cont_vars == yvar]
    )
  })
  
  # ---- Data table ----
  output$data_table <- renderDT({
    datatable(dig, options = list(pageLength = 25))
  })
}



# Run the application 
shinyApp(ui = ui, server = server)
